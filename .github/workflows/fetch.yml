
name: Fetch updates

on:
  [workflow_dispatch]
jobs:
  fetch:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    - name: üèó Install SSH Key
      uses: shimataro/ssh-key-action@v2
      with:
        key: ${{ secrets.SSH_PRIVATE_KEY }} 
        known_hosts: 'just-a-placeholder'
    
    - name: Add known hosts
      run: ssh-keyscan -H ${{ secrets.LINODE_IP_ADDRESS }} >> ~/.ssh/known_hosts
      
    - name: üéÅ Attempt to create a new tmux session
      continue-on-error: true
      run: |
        # programming.dev blocks gh actions
        ssh -t ${{ secrets.SSH_USER }}@${{ secrets.LINODE_IP_ADDRESS }} ' curl https://programming.dev/feeds/u/emma.xml?sort=New' | sed 's/Connection to ${{ secrets.LINODE_IP_ADDRESS }} closed.//' >> lemmy.xml
        echo lemmy.xml
    - name: üß∂ Install deps
      run: |
        yarn
    - name: ‚¨á Download SimpleRSSAggregator artifact
      uses: dawidd6/action-download-artifact@v2
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        workflow: ci.yml
        workflow_conclusion: success
        branch: development
        path: ./
        name: SimpleRSSAggregator
        repo: MarmadileManteater/SimpleRSSAggregator
        check_artifacts:  false
        search_artifacts: false
        skip_unpack: false
        if_no_artifact_found: fail
    - name: üîì Allow executing SimpleRSSAggregator
      run: |
        chmod +x ./syndication_junction
    - name: üê∂ Fetch feeds into db.json
      run: |
        ./syndication_junction fetch https://marmadilemanteater.dev/blog/rss.xml https://gamemaking.social/@emma.rss https://programming.dev/feeds/u/emma.xml?sort=New https://opengameart.org/users/105608/art.xml https://itch.io/games/newest/by-marmadilemanteater.xml https://pxlmo.com/users/emma.atom
    - name: üñ® Output to RSS
      run: |
        ./syndication_junction output-rss feed.xml https://raw.githubusercontent.com/MarmadileManteater/MySocialFeed/development
    - uses: actions/upload-artifact@v3
      with:
        name: feed
        path: feed.xml
#    - name: üìù Commit feed.xml back to the repo
#      run: |
#        git config --global user.name "gh actions bot"
#        git config --global user.email "gh-actions-bot[bot]@MarmadileManteater.github.io"
#        git add .
#        # Force the build to succeed, even if no files were changed
#        git commit -m 'Update files' || true
#        git push
