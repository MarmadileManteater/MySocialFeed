
name: Fetch updates

on:
  [workflow_dispatch]
jobs:
  fetch:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    - name: 🏗 Install SSH Key
      uses: shimataro/ssh-key-action@v2
      with:
        key: ${{ secrets.SSH_PRIVATE_KEY }} 
        known_hosts: 'just-a-placeholder'
    
    - name: Add known hosts
      run: ssh-keyscan -H ${{ secrets.LINODE_IP_ADDRESS }} >> ~/.ssh/known_hosts
      
    - name: 🎭 Use my linode as a proxy for programming.dev because they block connections from gh-actions agents 🤫
      continue-on-error: true
      run: |
        # programming.dev blocks gh actions
        mkdir lemmy/
        ssh -t ${{ secrets.SSH_USER }}@${{ secrets.LINODE_IP_ADDRESS }} ' curl https://programming.dev/feeds/u/emma.xml?sort=New' | sed 's/Connection to ${{ secrets.LINODE_IP_ADDRESS }} closed.//' >> lemmy/feed.xml
        npm i -g http-server
        cd lemmy
        # create an http server to serve the content
        npx http-server -p9000&
    - name: 🧶 Install deps
      run: |
        yarn
    - name: ⬇ Download SimpleRSSAggregator artifact
      uses: dawidd6/action-download-artifact@v2
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        workflow: ci.yml
        workflow_conclusion: success
        branch: development
        path: ./
        name: SimpleRSSAggregator
        repo: MarmadileManteater/SimpleRSSAggregator
        check_artifacts:  false
        search_artifacts: false
        skip_unpack: false
        if_no_artifact_found: fail
    - name: 🔓 Allow executing SimpleRSSAggregator
      run: |
        chmod +x ./syndication_junction
    - name: 🐶 Fetch feeds into db.json
      run: |
        ./syndication_junction fetch https://marmadilemanteater.dev/blog/rss.xml https://gamemaking.social/@emma.rss http://127.0.0.1:9000/feed.xml https://opengameart.org/users/105608/art.xml https://itch.io/games/newest/by-marmadilemanteater.xml https://pxlmo.com/users/emma.atom
    - name: 🖨 Output to RSS
      run: |
        ./syndication_junction output-rss feed.xml https://raw.githubusercontent.com/MarmadileManteater/MySocialFeed/development
    - name: 📂 Create output dir
      run: |
        mkdir output
        cp feed.xml output
        cp -r media/ output
    - uses: actions/upload-artifact@v3
      with:
        name: feed
        path: output/
#    - name: 📝 Commit feed.xml back to the repo
#      run: |
#        git config --global user.name "gh actions bot"
#        git config --global user.email "gh-actions-bot[bot]@MarmadileManteater.github.io"
#        git add .
#        # Force the build to succeed, even if no files were changed
#        git commit -m 'Update files' || true
#        git push
